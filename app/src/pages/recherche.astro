---
import DashboardLayout from '../layouts/DashboardLayout.astro'
import Layout from '../layouts/Layout.astro'
import SearchResults from '../components/SearchResults.astro'
import VinylDetailsModal from '../components/VinylDetailsModal.astro'
import ViewToggle from '../components/ui/ViewToggle.astro'
import { ScanSearch } from '@lucide/astro/icons'
---

<Layout title="Recherche">
  <DashboardLayout title="Recherche" currentPath="/recherche">
    <div class="mb-6">
      <h1 class="mb-4 text-xl font-bold text-neutral-900 dark:text-neutral-100">
        Rechercher un Vinyle
      </h1>

      <div class="rounded-lg bg-neutral-100 p-6 shadow-sm dark:bg-neutral-800">
        <div class="flex flex-col gap-4 md:flex-row">
          <div class="flex-1">
            <label
              for="search-input"
              class="mb-2 block text-xs font-medium text-neutral-700 dark:text-neutral-300"
            >
              Recherche
            </label>
            <input
              type="text"
              id="search-input"
              placeholder="Artiste, album, genre..."
              class="w-full rounded-lg border border-neutral-300 px-4 py-2 focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-neutral-100"
            />
          </div>
          <div class="md:w-48">
            <label
              for="genre-filter"
              class="mb-2 block text-xs font-medium text-neutral-700 dark:text-neutral-300"
            >
              Genre
            </label>
            <select
              id="genre-filter"
              class="w-full rounded-lg border border-neutral-300 px-4 py-2 focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-neutral-100"
            >
              <option value="">Tous les genres</option>
              <option value="rock">Rock</option>
              <option value="jazz">Jazz</option>
              <option value="electronic">Electronic</option>
              <option value="classical">Classical</option>
              <option value="blues">Blues</option>
            </select>
          </div>
          <div class="md:w-32">
            <label
              for="year-filter"
              class="mb-2 block text-xs font-medium text-neutral-700 dark:text-neutral-300"
            >
              Année
            </label>
            <input
              type="number"
              id="year-filter"
              placeholder="2024"
              class="w-full rounded-lg border border-neutral-300 px-4 py-2 focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-neutral-100"
            />
          </div>
          <div class="flex items-end">
            <button
              id="search-btn"
              class="bg-gradient-rock hover:bg-gradient-rock-hover flex items-center gap-2 rounded-lg px-6 py-2 text-neutral-100 shadow-md transition-all duration-300 ease-in-out hover:shadow-lg"
            >
              <ScanSearch class="h-4 w-4" />
              Rechercher
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contrôles de vue et résultats -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h2 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">
          Résultats de recherche
        </h2>
        <span id="results-count" class="text-sm text-neutral-500 dark:text-neutral-400"
          >0 résultats</span
        >
      </div>
      <ViewToggle currentView="grid" availableViews={['grid', 'list', 'timeline']} />
    </div>

    <!-- Résultats -->
    <div id="search-results-container">
      <SearchResults
        results={[
          {
            id: '2',
            title: 'Kind of Blue',
            artist: 'Miles Davis',
            year: '1959',
            genre: ['Jazz'],
            thumb: undefined,
            country: 'États-Unis',
            label: 'Columbia Records',
            format: 'LP, Album, Reissue',
            tracklist: [
              { position: 'A1', title: 'So What', duration: '9:22' },
              { position: 'A2', title: 'Blue in Green', duration: '5:37' },
              { position: 'A3', title: 'All Blues', duration: '11:33' },
              { position: 'B1', title: 'Flamenco Sketches', duration: '9:26' },
              { position: 'B2', title: 'Freddie Freeloader', duration: '9:46' },
            ],
            notes:
              "Album révolutionnaire qui a défini le jazz modal. Considéré comme l'un des albums les plus influents de l'histoire du jazz.",
          },
          {
            id: '5',
            title: 'Revolver',
            artist: 'The Beatles',
            year: '1966',
            genre: ['Rock', 'Psychedelic Rock'],
            thumb: undefined,
            country: 'Royaume-Uni',
            label: 'Parlophone Records',
            format: 'LP, Album, Mono',
            tracklist: [
              { position: 'A1', title: 'Taxman', duration: '2:39' },
              { position: 'A2', title: 'Eleanor Rigby', duration: '2:07' },
              { position: 'A3', title: "I'm Only Sleeping", duration: '3:01' },
              { position: 'A4', title: 'Love You To', duration: '3:01' },
              { position: 'A5', title: 'Here, There and Everywhere', duration: '2:25' },
              { position: 'A6', title: 'Yellow Submarine', duration: '2:40' },
              { position: 'B1', title: 'She Said She Said', duration: '2:37' },
              { position: 'B2', title: 'Good Day Sunshine', duration: '2:09' },
              { position: 'B3', title: 'And Your Bird Can Sing', duration: '2:01' },
              { position: 'B4', title: 'For No One', duration: '2:01' },
              { position: 'B5', title: 'Doctor Robert', duration: '2:15' },
              { position: 'B6', title: 'I Want to Tell You', duration: '2:29' },
              { position: 'B7', title: 'Got to Get You Into My Life', duration: '2:30' },
              { position: 'B8', title: 'Tomorrow Never Knows', duration: '2:57' },
            ],
            notes:
              'Album marquant le tournant psychédélique des Beatles, avec des innovations sonores révolutionnaires.',
          },
          {
            id: '12',
            title: 'Pet Sounds',
            artist: 'The Beach Boys',
            year: '1966',
            genre: ['Pop', 'Psychedelic Pop'],
            thumb: undefined,
            country: 'États-Unis',
            label: 'Capitol Records',
            format: 'LP, Album',
            tracklist: [
              { position: 'A1', title: "Wouldn't It Be Nice", duration: '2:25' },
              { position: 'A2', title: 'You Still Believe in Me', duration: '2:31' },
              { position: 'A3', title: "That's Not Me", duration: '2:28' },
              {
                position: 'A4',
                title: "Don't Talk (Put Your Head on My Shoulder)",
                duration: '2:53',
              },
              { position: 'A5', title: "I'm Waiting for the Day", duration: '3:05' },
              { position: 'A6', title: "Let's Go Away for Awhile", duration: '2:18' },
              { position: 'A7', title: 'Sloop John B', duration: '2:58' },
              { position: 'B1', title: 'God Only Knows', duration: '2:51' },
              { position: 'B2', title: "I Know There's an Answer", duration: '3:09' },
              { position: 'B3', title: 'Here Today', duration: '2:54' },
              { position: 'B4', title: "I Just Wasn't Made for These Times", duration: '3:12' },
              { position: 'B5', title: 'Pet Sounds', duration: '2:22' },
              { position: 'B6', title: 'Caroline, No', duration: '2:51' },
            ],
            notes:
              "Chef-d'œuvre de Brian Wilson, considéré comme l'un des albums les plus influents de l'histoire de la pop.",
          },
          {
            id: '4',
            title: 'Abbey Road',
            artist: 'The Beatles',
            year: '1969',
            genre: ['Rock', 'Pop'],
            thumb: undefined,
            country: 'Royaume-Uni',
            label: 'Apple Records',
            format: 'LP, Album',
            tracklist: [
              { position: 'A1', title: 'Come Together', duration: '4:20' },
              { position: 'A2', title: 'Something', duration: '3:03' },
              { position: 'A3', title: "Maxwell's Silver Hammer", duration: '3:27' },
              { position: 'A4', title: 'Oh! Darling', duration: '3:26' },
              { position: 'A5', title: "Octopus's Garden", duration: '2:51' },
              { position: 'A6', title: "I Want You (She's So Heavy)", duration: '7:47' },
              { position: 'B1', title: 'Here Comes the Sun', duration: '3:05' },
              { position: 'B2', title: 'Because', duration: '2:45' },
              { position: 'B3', title: 'You Never Give Me Your Money', duration: '4:02' },
              { position: 'B4', title: 'Sun King', duration: '2:26' },
              { position: 'B5', title: 'Mean Mr. Mustard', duration: '1:06' },
              { position: 'B6', title: 'Polythene Pam', duration: '1:12' },
              {
                position: 'B7',
                title: 'She Came In Through the Bathroom Window',
                duration: '1:57',
              },
              { position: 'B8', title: 'Golden Slumbers', duration: '1:31' },
              { position: 'B9', title: 'Carry That Weight', duration: '1:36' },
              { position: 'B10', title: 'The End', duration: '2:19' },
              { position: 'B11', title: 'Her Majesty', duration: '0:23' },
            ],
            notes:
              'Dernier album enregistré par les Beatles, célèbre pour sa pochette iconique et sa suite musicale finale.',
          },
          {
            id: '15',
            title: 'The Dark Side of the Moon',
            artist: 'Pink Floyd',
            year: '1973',
            genre: ['Rock', 'Progressive Rock'],
            thumb: undefined,
            country: 'Royaume-Uni',
            label: 'Harvest Records',
            format: 'LP, Album',
            tracklist: [
              { position: 'A1', title: 'Speak to Me', duration: '1:30' },
              { position: 'A2', title: 'Breathe (In the Air)', duration: '2:43' },
              { position: 'A3', title: 'On the Run', duration: '3:30' },
              { position: 'A4', title: 'Time', duration: '6:53' },
              { position: 'A5', title: 'The Great Gig in the Sky', duration: '4:43' },
              { position: 'B1', title: 'Money', duration: '6:22' },
              { position: 'B2', title: 'Us and Them', duration: '7:49' },
              { position: 'B3', title: 'Any Colour You Like', duration: '3:25' },
              { position: 'B4', title: 'Brain Damage', duration: '3:46' },
              { position: 'B5', title: 'Eclipse', duration: '2:03' },
            ],
            notes:
              "Album conceptuel sur la folie et la pression de la vie moderne. L'un des albums les plus vendus de tous les temps.",
          },
        ]}
        currentView="grid"
        availableViews={['grid', 'list', 'timeline']}
      />
    </div>

    <!-- Modal -->
    <VinylDetailsModal />
  </DashboardLayout>
</Layout>

<script>
  // Éléments DOM
  const searchBtn = document.getElementById('search-btn')
  const searchInput = document.getElementById('search-input')
  const genreFilter = document.getElementById('genre-filter')
  const yearFilter = document.getElementById('year-filter')
  const resultsCount = document.getElementById('results-count')

  // Recherche
  const performSearch = async () => {
    const query = (searchInput as HTMLInputElement)?.value?.trim()
    if (!query) return

    try {
      const params = new URLSearchParams({ q: query })
      if ((genreFilter as HTMLSelectElement)?.value) params.append('type', 'release')

      const response = await fetch(`/api/search.json?${params}`)
      const data = await response.json()

      if (data.results) {
        resultsCount!.textContent = `${data.results.length} résultat${data.results.length > 1 ? 's' : ''}`
      } else {
        resultsCount!.textContent = '0 résultats'
      }
    } catch (error) {
      console.error('Erreur de recherche:', error)
      resultsCount!.textContent = '0 résultats'
    }
  }

  // Événements
  searchBtn?.addEventListener('click', performSearch)
  searchInput?.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      performSearch()
    }
  })

  // Initialiser le compteur de résultats
  resultsCount!.textContent = '5 résultats'
</script>
