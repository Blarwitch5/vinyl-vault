---
// Navbar pour la navigation principale
import { ThemeToggle } from './theme-toggle'
import NavbarSearch from './NavbarSearch.astro'
import SkeletonLoader from './SkeletonLoader.astro'
---

<!-- Navbar Top (Logo + User) -->
<nav
  class="glass dark:glass-dark border-b border-neutral-200/50 dark:border-neutral-800/50 transition-colors duration-300 relative z-50"
>
  <div class="container mx-auto px-3 sm:px-4">
    <div class="flex items-center justify-between h-12 sm:h-16">
      <!-- Logo -->
      <div class="flex items-center">
        <a href="/" class="flex items-center space-x-2">
          <!-- Icône vinyle avec gradient -->
          <div class="flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="url(#vinyl-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-disc3-icon lucide-disc-3 sm:w-8 sm:h-8">
              <circle cx="12" cy="12" r="10"/>
              <path d="M6 12c0-1.7.7-3.2 1.8-4.2"/>
              <circle cx="12" cy="12" r="2"/>
              <path d="M18 12c0 1.7-.7 3.2-1.8 4.2"/>
            </svg>
            <!-- Gradient SVG -->
            <svg width="0" height="0" style="position: absolute;">
              <defs>
                <linearGradient id="vinyl-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#14b8a6;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
                </linearGradient>
              </defs>
            </svg>
          </div>
          
          <!-- Texte du logo selon les breakpoints -->
          <!-- Mobile : sans texte -->
          <!-- Tablet : VV -->
          <span class="hidden md:block lg:hidden text-xl font-bold text-neutral-900 dark:text-neutral-50" style="font-family: 'Poppins', sans-serif; font-weight: 700;">VV</span>
          <!-- Desktop : VinylVault complet -->
          <span class="hidden lg:block text-xl font-bold text-neutral-900 dark:text-neutral-50" style="font-family: 'Poppins', sans-serif; font-weight: 700;">VinylVault</span>
        </a>
      </div>

      <!-- Barre de recherche pour tous les écrans -->
      <div class="flex flex-1 justify-center max-w-sm sm:max-w-md mx-2 sm:mx-4">
        <NavbarSearch />
      </div>

      <!-- User Menu (droite) -->
      <div class="flex items-center space-x-2 sm:space-x-3">

        <!-- Skeleton User Menu (affiché pendant le chargement) -->
        <div id="user-skeleton" class="flex items-center space-x-3">
          <SkeletonLoader type="avatar" />
          <SkeletonLoader type="text" width="w-16" height="h-4" />
        </div>

        <!-- Menu utilisateur connecté -->
        <div id="user-menu" class="hidden relative">
          <button
            id="user-menu-button"
            class="flex items-center space-x-1 sm:space-x-3 text-neutral-600 dark:text-neutral-400 hover:text-emerald-500 dark:hover:text-emerald-500 transition-colors"
          >
            <!-- Avatar utilisateur -->
            <div
              id="user-avatar"
              class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg sm:rounded-xl border-2 border-neutral-200 dark:border-white/10 overflow-hidden"
            >
              <img src="/default-avatar.svg" alt="Avatar" class="w-full h-full object-cover" />
            </div>
            <!-- Nom utilisateur (masqué sur mobile) -->
            <span id="user-name" class="hidden md:inline text-sm font-medium"></span>
            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown menu -->
          <div
            id="user-dropdown"
            class="hidden absolute top-full mt-2 right-0 w-48 bg-white dark:bg-neutral-950 rounded-xl shadow-lg dark:shadow-neutral-900/50 z-[60] border border-neutral-200 dark:border-neutral-800 flex-col overflow-hidden"
          >
            <div class="py-2">
              <a
                href="/profile"
                class="flex items-center space-x-3 px-4 py-2 text-sm text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-900 transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Mon Profil</span>
              </a>
              <a
                href="/dashboard"
                class="flex items-center space-x-3 px-4 py-2 text-sm text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-900 transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="m16 6 4 14"/>
                  <path d="M12 6v14"/>
                  <path d="M8 8v12"/>
                  <path d="M4 4v16"/>
                </svg>
                <span>Ma Collection</span>
              </a>
              <button
                id="stats-button"
                class="flex items-center space-x-3 w-full text-left px-4 py-2 text-sm text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-900 transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="M3 3v16a2 2 0 0 0 2 2h16"/>
                  <path d="M18 17V9"/>
                  <path d="M13 17V5"/>
                  <path d="M8 17v-3"/>
                </svg>
                <span>Statistiques</span>
              </button>
              <div class="border-t border-neutral-200 dark:border-white/10 my-1"></div>
              <button
                id="logout-button"
                class="flex items-center space-x-3 w-full text-left px-4 py-2 text-sm text-neutral-600 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-900 transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <polyline points="16,17 21,12 16,7"/>
                  <line x1="21" x2="9" y1="12" y2="12"/>
                </svg>
                <span>Se Déconnecter</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Skeleton Guest Menu (affiché pendant le chargement) -->
        <div id="guest-skeleton" class="flex items-center space-x-4">
          <SkeletonLoader type="text" width="w-16" height="h-4" />
          <SkeletonLoader type="button" className="w-20" />
        </div>

        <!-- Menu non connecté -->
        <div id="guest-menu" class="items-center space-x-4 hidden">
          <a
            href="/login"
            class="text-neutral-600 dark:text-neutral-400 hover:text-emerald-500 dark:hover:text-emerald-500 transition-colors"
          >
            Connexion
          </a>
          <a
            href="/register"
            class="bg-gradient-emerald text-white px-4 py-2 rounded-xl hover:bg-gradient-emerald/80 transition-colors"
          >
            Inscription
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>


<script>
  import { getCurrentUser, logout } from '../lib/auth.js'
import {
smoothHide,
smoothShow,
smoothToggleBetween,
smoothToggleDropdown
} from '../utils/smooth-toggle.js'

  // Configuration des animations
  const ANIMATION_DURATIONS = {
    FAST: 150,
    NORMAL: 200,
    SLOW: 250,
  } as const

  // Sélecteurs d'éléments
  const SELECTORS = {
    // Menus principaux
    userMenu: 'user-menu',
    guestMenu: 'guest-menu',

    // Éléments utilisateur
    userName: 'user-name',
    userAvatar: 'user-avatar',
    userMenuButton: 'user-menu-button',
    userDropdown: 'user-dropdown',

    // Boutons d'action
    logoutButton: 'logout-button',
    statsButton: 'stats-button',


    // Skeletons
    skeletons: ['user-skeleton', 'guest-skeleton'],
  } as const

  // Gradients pour les avatars
  const AVATAR_GRADIENTS = {
    blue: 'linear-gradient(135deg, #60a5fa, #2563eb)',
    emerald: 'linear-gradient(135deg, #6ee7b7, #059669)',
    purple: 'linear-gradient(135deg, #c084fc, #9333ea)',
    red: 'linear-gradient(135deg, #f87171, #dc2626)',
    orange: 'linear-gradient(135deg, #fb923c, #ea580c)',
    pink: 'linear-gradient(135deg, #f472b6, #ec4899)',
    indigo: 'linear-gradient(135deg, #818cf8, #4f46e5)',
  } as const

  class NavbarController {
    private elements: Record<string, HTMLElement | null> = {}

    constructor() {
      this.initializeElements()
    }

    private initializeElements(): void {
      // Récupérer tous les éléments DOM
      Object.entries(SELECTORS).forEach(([key, value]) => {
        if (Array.isArray(value)) {
          // Pour les skeletons (array)
          value.forEach((id) => {
            this.elements[id] = document.getElementById(id)
          })
        } else {
          this.elements[key] = document.getElementById(value as string)
        }
      })
    }

    private hideSkeletons(): void {
      SELECTORS.skeletons.forEach((skeleton) => {
        this.elements[skeleton]?.classList.add('hidden')
      })
    }

    private setupUserState(user: any): void {
      const {
        userMenu,
        guestMenu,
      } = this.elements

      // Animations des menus
      if (userMenu && guestMenu)
        smoothToggleBetween(userMenu, guestMenu, 'flex', ANIMATION_DURATIONS.NORMAL)

      // Informations utilisateur
      this.updateUserInfo(user)
      this.setupUserInteractions()
    }

    private setupGuestState(): void {
      const { userMenu, guestMenu } = this.elements

      if (guestMenu && userMenu)
        smoothToggleBetween(guestMenu, userMenu, 'flex', ANIMATION_DURATIONS.NORMAL)
    }

    private updateUserInfo(user: any): void {
      const { userName, userAvatar } = this.elements

      // Nom d'utilisateur
      if (userName) {
        const fullName = user.name || user.email.split('@')[0]
        const displayName = fullName.length > 10 ? fullName.substring(0, 10) + '...' : fullName
        
        userName.textContent = displayName
        userName.title = fullName // Tooltip avec le nom complet
        userName.setAttribute('data-tooltip', fullName)
      }

      // Avatar
      if (userAvatar) {
        const avatar = user.avatar || '/default-avatar.svg'
        this.updateUserAvatar(avatar)
      }
    }

    private updateUserAvatar(avatar: string): void {
      const { userAvatar } = this.elements
      if (!userAvatar) return

      const avatarImg = userAvatar.querySelector('img')

      if (avatar.startsWith('/')) {
        // Avatar par défaut (fichier SVG)
        if (avatarImg) {
          avatarImg.src = avatar
          avatarImg.style.display = 'block'
        }
        userAvatar.style.background = ''
      } else {
        // Avatar coloré (gradient)
        if (avatarImg) avatarImg.style.display = 'none'
        userAvatar.style.background =
          AVATAR_GRADIENTS[avatar as keyof typeof AVATAR_GRADIENTS] || AVATAR_GRADIENTS.blue
      }
    }

    private setupUserInteractions(): void {
      const { userMenuButton, userDropdown, logoutButton, statsButton } = this.elements

      // Dropdown utilisateur
      if (userMenuButton && userDropdown) {
        userMenuButton.addEventListener('click', (e) => {
          e.stopPropagation()
          smoothToggleDropdown(userDropdown, userMenuButton, ANIMATION_DURATIONS.FAST)
        })
      }

      // Statistiques personnelles
      if (statsButton) {
        statsButton.addEventListener('click', () => {
          // Fermer le dropdown
          if (userDropdown) smoothHide(userDropdown, ANIMATION_DURATIONS.FAST)
          
          // Ouvrir le modal des statistiques
          document.dispatchEvent(new CustomEvent('modal:personal-stats:open'))
        })
      }

      // Déconnexion
      const handleLogout = () => logout()
      logoutButton?.addEventListener('click', handleLogout)
    }

    private setupMobileInteractions(): void {
      // Interactions mobiles supprimées - plus de BottomNavbar
      console.log('Mobile interactions removed')
    }

    async initialize(): Promise<void> {
      try {
        const user = await getCurrentUser()

        if (user && this.elements.userMenu && this.elements.guestMenu && this.elements.userName) {
          this.setupUserState(user)
        } else {
          this.setupGuestState()
        }
      } catch (error) {
        console.error("Erreur lors de la vérification de l'authentification:", error)
        this.setupGuestState()
      } finally {
        this.hideSkeletons()
        this.setupMobileInteractions()
      }
    }

  }

  // Types globaux sont maintenant définis dans src/types/window.d.ts

  // Initialisation
  document.addEventListener('DOMContentLoaded', async () => {
    const navbar = new NavbarController()
    await navbar.initialize()
  })
</script>

<style>

  /* Tooltip élégant pour le nom d'utilisateur */
  #user-name {
    position: relative;
    cursor: help;
  }

  #user-name:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    margin-top: 4px;
    animation: tooltipFadeIn 0.2s ease-out;
  }

  #user-name:hover::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-bottom-color: #1f2937;
    z-index: 1000;
    margin-top: -1px;
    animation: tooltipFadeIn 0.2s ease-out;
  }

  @keyframes tooltipFadeIn {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* Dark mode pour le tooltip */
  .dark #user-name:hover::after {
    background: #f3f4f6;
    color: #111827;
  }

  .dark #user-name:hover::before {
    border-bottom-color: #f3f4f6;
  }

  /* Correction des coins qui dépassent dans le dropdown */
  #user-dropdown a:first-child,
  #user-dropdown button:first-child {
    border-top-left-radius: 0.75rem;
    border-top-right-radius: 0.75rem;
  }

  #user-dropdown a:last-child,
  #user-dropdown button:last-child {
    border-bottom-left-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
  }

  /* S'assurer que les éléments du dropdown respectent les coins arrondis */
  #user-dropdown .py-2 > * {
    border-radius: 0;
  }

  #user-dropdown .py-2 > *:first-child {
    border-top-left-radius: 0.75rem;
    border-top-right-radius: 0.75rem;
  }

  #user-dropdown .py-2 > *:last-child {
    border-bottom-left-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
  }
</style>
