---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import VinylCard from "../../components/VinylCard.astro";
import VinylCardCompact from "../../components/VinylCardCompact.astro";
import BarcodeScannerModal from "../../components/BarcodeScannerModal.astro";
import DeleteVinylModal from "../../components/DeleteVinylModal.astro";
import { PrismaClient } from "@prisma/client";
import jwt from "jsonwebtoken";

const prisma = new PrismaClient();

// Récupérer l'ID de la collection depuis l'URL
const { id } = Astro.params;

const title = `Collection #${id} - VinylVault`;
const description = "Explorez cette collection de vinyles en détail";

// Vérifier l'authentification
let currentUser = null;
let isAuthenticated = false;

try {
  const token = Astro.cookies.get("vinyl_vault_token")?.value;
  if (token) {
    const jwtSecret = import.meta.env.JWT_SECRET || "your-super-secret-jwt-key";
    const decoded = jwt.verify(token, jwtSecret) as any;
    currentUser = await prisma.user.findUnique({
      where: { id: decoded.userId },
      select: { id: true, name: true, email: true },
    });
    isAuthenticated = !!currentUser;
  }
} catch (error) {
  console.error("Erreur d'authentification:", error);
}

// Récupérer les vraies données de la collection depuis la base de données
let collection: any = null;
let collectionVinyls: any[] = [];
let error: string | null = null;

try {
  collection = await prisma.collection.findUnique({
    where: { id: id as string },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          email: true,
        },
      },
      vinyls: {
        orderBy: {
          createdAt: 'desc'
        }
      },
    },
  });

  if (collection) {
    collectionVinyls = collection.vinyls;
    console.log('Vinyles récupérés:', collectionVinyls);
  } else {
    error = "Collection non trouvée";
  }
} catch (err) {
  console.error("Erreur lors de la récupération de la collection:", err);
  error = "Erreur lors du chargement de la collection";
}

// Calculer les statistiques de la collection
const stats: {
  topArtists: { name: string; count: number }[];
  formatBreakdown: { format: string; count: number; percentage: number }[];
  conditionBreakdown: { condition: string; count: number; percentage: number }[];
} = {
  topArtists: [],
  formatBreakdown: [],
  conditionBreakdown: [],
};

if (collection && collectionVinyls.length > 0) {
  // Top artistes
  const artistCounts: { [key: string]: number } = {};
  collectionVinyls.forEach((vinyl: any) => {
    artistCounts[vinyl.artist] = (artistCounts[vinyl.artist] || 0) + 1;
  });
  stats.topArtists = Object.entries(artistCounts)
    .map(([name, count]) => ({ name, count: count as number }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 5);

  // Répartition par format
  const formatCounts: { [key: string]: number } = {};
  collectionVinyls.forEach((vinyl: any) => {
    const format = vinyl.format || 'Inconnu';
    formatCounts[format] = (formatCounts[format] || 0) + 1;
  });
  const totalVinyls = collectionVinyls.length;
  stats.formatBreakdown = Object.entries(formatCounts)
    .map(([format, count]) => ({
      format,
      count: count as number,
      percentage: Math.round(((count as number) / totalVinyls) * 100)
    }))
    .sort((a, b) => b.count - a.count);

  // Répartition par état
  const conditionCounts: { [key: string]: number } = {};
  collectionVinyls.forEach((vinyl: any) => {
    const condition = vinyl.condition || 'Inconnu';
    conditionCounts[condition] = (conditionCounts[condition] || 0) + 1;
  });
  stats.conditionBreakdown = Object.entries(conditionCounts)
    .map(([condition, count]) => ({
      condition,
      count: count as number,
      percentage: Math.round(((count as number) / totalVinyls) * 100)
    }))
    .sort((a, b) => b.count - a.count);
}

// Filtres et tri
const sortBy = Astro.url.searchParams.get("sort") || "title";
const filterGenre = Astro.url.searchParams.get("genre") || "";
const filterFormat = Astro.url.searchParams.get("format") || "";
---

<BaseLayout title={title} description={description}>
  <Navbar slot="navbar" />

  <div class="container mx-auto px-4 py-8">
    {error ? (
      <div class="text-center py-12">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-8 max-w-md mx-auto">
          <div class="text-red-600 dark:text-red-400 mb-4">
            <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-red-800 dark:text-red-200 mb-2">
            Erreur
          </h2>
          <p class="text-red-700 dark:text-red-300 mb-4">
            {error}
          </p>
          <a 
            href="/dashboard" 
            class="inline-flex items-center px-4 py-2 bg-gradient-emerald dark:bg-gradient-emerald text-white rounded-xl hover:bg-gradient-emerald/80 dark:hover:bg-gradient-emerald/80 transition-colors"
          >
            Retour au tableau de bord
          </a>
        </div>
      </div>
    ) : collection ? (
    <div
      class="bg-neutral-50 dark:bg-black/20 dark:glass-emerald-border rounded-xl shadow-sm dark:shadow-white p-6 mb-8"
    >
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center mb-2">
            <h1
              class="text-3xl font-bold text-neutral-900 dark:text-neutral-50 mr-3"
            >
              {collection.name}
            </h1>
            <span
              class={`px-3 py-1 rounded-full text-sm font-medium ${
                collection.isPublic
                  ? "bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400"
                  : "glass dark:glass-dark shadow-sm dark:shadow-white text-neutral-900 dark:text-neutral-50"
              }`}
            >
              {
                collection.isPublic
                  ? "Collection publique"
                  : "Collection privée"
              }
            </span>
          </div>

          <p class="text-neutral-600 dark:text-neutral-400 mb-4">
            {collection.description || "Aucune description disponible"}
          </p>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span
                class="text-neutral-600 dark:text-neutral-400"
                >Propriétaire:</span
              >
              <p class="font-medium text-neutral-900 dark:text-neutral-50">
                {collection.user.name || collection.user.email}
              </p>
            </div>
            <div>
              <span
                class="text-neutral-600 dark:text-neutral-400"
                >Vinyles:</span
              >
              <p class="font-medium text-neutral-900 dark:text-neutral-50">
                {collectionVinyls.length}
              </p>
            </div>
            <div>
              <span
                class="text-neutral-600 dark:text-neutral-400"
                >Valeur totale:</span
              >
              <p class="font-medium text-neutral-900 dark:text-neutral-50">
                {collectionVinyls.reduce((sum: number, vinyl: any) => sum + (vinyl.price || 0), 0).toFixed(2)} €
              </p>
            </div>
            <div>
              <span
                class="text-neutral-600 dark:text-neutral-400"
                >Dernière mise à jour:</span
              >
              <p class="font-medium text-neutral-900 dark:text-neutral-50">
                {new Date(collection.updatedAt).toLocaleDateString("fr-FR")}
              </p>
            </div>
          </div>
        </div>

        {
          currentUser && currentUser.id === collection.userId && (
            <div class="flex space-x-2">
              <button class="bg-gradient-emerald dark:bg-gradient-emerald text-white px-4 py-2 rounded-xl hover:bg-gradient-emerald/80 dark:hover:bg-gradient-emerald/80 transition-colors">
                Modifier
              </button>
              <button class=" text-neutral-900 dark:text-neutral-50 px-4 py-2 rounded-xl hover:bg-white dark:hover:bg-neutral-900 transition-colors">
                Partager
              </button>
            </div>
          )
        }
      </div>
    </div>

    <div class="grid lg:grid-cols-4 gap-6">
      <!-- Sidebar - Filtres et statistiques -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Filtres -->
        <div class="mb-6 md:mb-0">
      <div class="glass dark:glass-dark rounded-xl shadow-sm">
          <div
            class="px-4 py-3 border-b border-neutral-200 dark:border-white/10"
          >
            <h3
              class="text-lg font-semibold text-neutral-900 dark:text-neutral-50"
            >
              Filtres
            </h3>
          </div>
          <div class="p-4 space-y-4">
            <form method="get" class="space-y-4">
              <!-- Tri -->
              <div>
                <label
                  for="sort"
                  class="block text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-1"
                >
                  Trier par
                </label>
                <select
                  id="sort"
                  name="sort"
                  class="w-full px-3 py-2  rounded-xl focus:outline-none focus:ring-2 focus:ring-light-accent1 dark:focus:ring-dark-accent1 bg-neutral-50 dark:bg-black/20 text-neutral-900 dark:text-neutral-50 text-sm"
                >
                  <option value="title" selected={sortBy === "title" ? true : undefined}
                    >Titre</option
                  >
                  <option value="artist" selected={sortBy === "artist" ? true : undefined}
                    >Artiste</option
                  >
                  <option value="year" selected={sortBy === "year" ? true : undefined}
                    >Année</option
                  >
                  <option value="price" selected={sortBy === "price" ? true : undefined}
                    >Prix</option
                  >
                  <option value="condition" selected={sortBy === "condition" ? true : undefined}
                    >État</option
                  >
                  <option value="added" selected={sortBy === "added" ? true : undefined}
                    >Date d'ajout</option
                  >
                </select>
              </div>

              <!-- Genre -->
              <div>
                <label
                  for="genre"
                  class="block text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-1"
                >
                  Genre
                </label>
                <select
                  id="genre"
                  name="genre"
                  class="w-full px-3 py-2  rounded-xl focus:outline-none focus:ring-2 focus:ring-light-accent1 dark:focus:ring-dark-accent1 bg-neutral-50 dark:bg-black/20 text-neutral-900 dark:text-neutral-50 text-sm"
                >
                  <option value="">Tous les genres</option>
                  <option value="rock" selected={filterGenre === "rock" ? true : undefined}
                    >Rock</option
                  >
                  <option value="jazz" selected={filterGenre === "jazz" ? true : undefined}
                    >Jazz</option
                  >
                  <option value="pop" selected={filterGenre === "pop" ? true : undefined}
                    >Pop</option
                  >
                  <option
                    value="electronic"
                    selected={filterGenre === "electronic" ? true : undefined}>Electronic</option
                  >
                </select>
              </div>

              <!-- Format -->
              <div>
                <label
                  for="format"
                  class="block text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-1"
                >
                  Format
                </label>
                <select
                  id="format"
                  name="format"
                  class="w-full px-3 py-2  rounded-xl focus:outline-none focus:ring-2 focus:ring-light-accent1 dark:focus:ring-dark-accent1 bg-neutral-50 dark:bg-black/20 text-neutral-900 dark:text-neutral-50 text-sm"
                >
                  <option value="">Tous les formats</option>
                  <option value="LP" selected={filterFormat === "LP" ? true : undefined}>LP</option
                  >
                  <option value="12" selected={filterFormat === "12" ? true : undefined}
                    >12"</option
                  >
                  <option value="7" selected={filterFormat === "7" ? true : undefined}>7"</option>
                  <option value="EP" selected={filterFormat === "EP" ? true : undefined}>EP</option
                  >
                </select>
              </div>

              <button
                type="submit"
                class="w-full bg-gradient-emerald dark:bg-gradient-emerald text-white px-4 py-2 rounded-xl hover:bg-gradient-emerald/80 dark:hover:bg-gradient-emerald/80 transition-colors text-sm"
              >
                Appliquer
              </button>
            </form>
          </div>
        </div>

        <!-- Statistiques - Visible sur desktop et tablette -->
        <div class="hidden md:block glass dark:glass-dark rounded-xl shadow-sm">
          <div class="px-4 py-3 border-b border-neutral-200 dark:border-white/10">
            <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-50">
              Statistiques
            </h3>
          </div>
          <div class="p-4 space-y-4">
            <!-- Top artistes -->
            <div>
              <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                Top artistes
              </h4>
              <div class="space-y-1">
                {
                  stats.topArtists.map((artist) => (
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-neutral-900 dark:text-neutral-50">
                        {artist.name}
                      </span>
                      <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                        {artist.count}
                      </span>
                    </div>
                  ))
                }
              </div>
            </div>

            <!-- Formats -->
            <div>
              <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                Formats
              </h4>
              <div class="space-y-2">
                {
                  stats.formatBreakdown.map((format) => (
                    <div>
                      <div class="flex items-center justify-between text-sm mb-1">
                        <span class="text-neutral-900 dark:text-neutral-50">
                          {format.format}
                        </span>
                        <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                          {format.count} ({format.percentage}%)
                        </span>
                      </div>
                      <div class="w-full glass dark:glass-dark shadow-sm dark:shadow-white rounded-full h-1">
                        <div
                          class="bg-gradient-emerald dark:bg-gradient-emerald h-1 rounded-full"
                          style={`width: ${format.percentage}%`}
                        />
                      </div>
                    </div>
                  ))
                }
              </div>
            </div>

            <!-- État -->
            <div>
              <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                État
              </h4>
              <div class="space-y-2">
                {
                  stats.conditionBreakdown.map((condition) => (
                    <div>
                      <div class="flex items-center justify-between text-sm mb-1">
                        <span class="text-neutral-900 dark:text-neutral-50">
                          {condition.condition}
                        </span>
                        <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                          {condition.count} ({condition.percentage}%)
                        </span>
                      </div>
                      <div class="w-full glass dark:glass-dark shadow-sm dark:shadow-white rounded-full h-1">
                        <div
                          class="bg-gradient-emerald dark:bg-gradient-emerald h-1 rounded-full"
                          style={`width: ${condition.percentage}%`}
                        />
                      </div>
                    </div>
                  ))
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistiques mobile - Visible uniquement sur mobile -->
      <div class="md:hidden mb-6">
        <div class="glass dark:glass-dark rounded-xl shadow-sm">
          <div class="px-4 py-3 border-b border-neutral-200 dark:border-white/10">
            <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-50">
              Statistiques
            </h3>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 gap-4">
              <!-- Top artistes -->
              <div>
                <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                  Top artistes
                </h4>
                <div class="space-y-1">
                  {
                    stats.topArtists.map((artist) => (
                      <div class="flex items-center justify-between text-sm">
                        <span class="text-neutral-900 dark:text-neutral-50">
                          {artist.name}
                        </span>
                        <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                          {artist.count}
                        </span>
                      </div>
                    ))
                  }
                </div>
              </div>

              <!-- Formats -->
              <div>
                <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                  Formats
                </h4>
                <div class="space-y-2">
                  {
                    stats.formatBreakdown.map((format) => (
                      <div>
                        <div class="flex items-center justify-between text-sm mb-1">
                          <span class="text-neutral-900 dark:text-neutral-50">
                            {format.format}
                          </span>
                          <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                            {format.count} ({format.percentage}%)
                          </span>
                        </div>
                        <div class="w-full glass dark:glass-dark shadow-sm dark:shadow-white rounded-full h-1">
                          <div
                            class="bg-gradient-emerald dark:bg-gradient-emerald h-1 rounded-full"
                            style={`width: ${format.percentage}%`}
                          />
                        </div>
                      </div>
                    ))
                  }
                </div>
              </div>

              <!-- État -->
              <div>
                <h4 class="text-sm font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                  État
                </h4>
                <div class="space-y-2">
                  {
                    stats.conditionBreakdown.map((condition) => (
                      <div>
                        <div class="flex items-center justify-between text-sm mb-1">
                          <span class="text-neutral-900 dark:text-neutral-50">
                            {condition.condition}
                          </span>
                          <span class="text-neutral-400 bg-neutral-900 px-2 py-1 rounded text-xs">
                            {condition.count} ({condition.percentage}%)
                          </span>
                        </div>
                        <div class="w-full glass dark:glass-dark shadow-sm dark:shadow-white rounded-full h-1">
                          <div
                            class="bg-gradient-emerald dark:bg-gradient-emerald h-1 rounded-full"
                            style={`width: ${condition.percentage}%`}
                          />
                        </div>
                      </div>
                    ))
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
    <!-- Contenu principal -->
      <div class="lg:col-span-3">
        <!-- En-tête avec actions -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div>
            <h2 class="text-2xl font-bold text-neutral-900 dark:text-neutral-50">
              Vinyles ({collectionVinyls.length})
            </h2>
            <p class="text-neutral-600 dark:text-neutral-400">
              {collectionVinyls.length} vinyles dans cette collection
            </p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Boutons de vue -->
            <div class="flex items-center bg-neutral-100 dark:bg-neutral-800 rounded-xl p-1">
              <button
                id="grid-view"
                class="px-3 py-1 rounded-xl text-sm font-medium bg-neutral-50 dark:bg-black/20 text-neutral-900 dark:text-neutral-50 shadow-sm dark:shadow-white dark:shadow-dark-card"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                  ></path>
                </svg>
              </button>
              <button
                id="list-view"
                class="px-3 py-1 rounded-xl text-sm font-medium text-neutral-600 dark:text-neutral-400"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
              </button>
            </div>
          </div>

          {
            currentUser && currentUser.id === collection.userId && (
              <button
                id="add-vinyl-collection-btn"
                class="bg-gradient-emerald dark:bg-gradient-emerald text-white px-4 py-2 rounded-xl hover:bg-gradient-emerald/80 dark:hover:bg-gradient-emerald/80 transition-colors"
              >
                + Ajouter un vinyle
              </button>
            )
          }
        </div>

        <!-- Grille des vinyles -->
        <div
          id="vinyl-grid"
          class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 mb-8"
        >
          {
            collectionVinyls.map((vinyl) => (
              <VinylCardCompact
                vinyl={vinyl}
                showActions={!!(currentUser && currentUser.id === collection.userId)}
                isInCollection={true}
              />
            ))
          }
        </div>

        <!-- Vue liste (cachée par défaut) -->
        <div id="vinyl-list" class="hidden space-y-4">
          {
            collectionVinyls.map((vinyl) => (
              <div class="glass dark:glass-dark rounded-xl p-4 flex items-center space-x-4 hover:bg-white/80 dark:hover:bg-neutral-900/80 transition-colors">
                <img
                  src={vinyl.coverImage || "/default-vinyl-cover.svg"}
                  alt={`Couverture de ${vinyl.title}`}
                  class="w-16 h-16 object-cover rounded-lg shadow-sm"
                />
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-neutral-900 dark:text-neutral-50 truncate">
                    {vinyl.title}
                  </h3>
                  <p class="text-neutral-600 dark:text-neutral-400 truncate">
                    {vinyl.artist}
                  </p>
                  <div class="flex items-center space-x-2 text-sm text-neutral-600 dark:text-neutral-400">
                    <span>{vinyl.year}</span>
                    <span>•</span>
                    <span>{vinyl.format}</span>
                    <span>•</span>
                    <span class={`px-2 py-1 rounded-full text-xs ${
                      vinyl.condition === 'Mint' ? 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400' :
                      vinyl.condition === 'Near Mint' ? 'bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-400' :
                      vinyl.condition === 'Very Good Plus' ? 'bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' :
                      vinyl.condition === 'Very Good' ? 'bg-orange-100 dark:bg-orange-900/20 text-orange-800 dark:text-orange-400' :
                      'bg-gray-100 dark:bg-gray-900/20 text-gray-800 dark:text-gray-400'
                    }`}>
                      {vinyl.condition}
                    </span>
                  </div>
                </div>
                <div class="text-right flex items-center space-x-4">
                  <div class="text-right">
                    <div class="font-semibold text-neutral-900 dark:text-neutral-50">
                      {vinyl.price?.toFixed(2)} €
                    </div>
                  </div>
                  {currentUser && currentUser.id === collection.userId && (
                    <div class="flex space-x-2 mt-2">
                      <button class="text-gradient-emerald dark:text-gradient-emerald hover:text-gradient-emerald/80 dark:hover:text-gradient-emerald/80 text-sm">
                        Modifier
                      </button>
                      <button 
                        class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 text-sm"
                        data-vinyl-id={vinyl.id || ''}
                        data-vinyl-title={vinyl.title || ''}
                        data-vinyl-artist={vinyl.artist || ''}
                        data-vinyl-year={vinyl.year || ''}
                        data-vinyl-format={vinyl.format || ''}
                        data-vinyl-condition={vinyl.condition || ''}
                        data-vinyl-price={vinyl.price || 0}
                        data-vinyl-cover={vinyl.coverImage || '/default-vinyl-cover.svg'}
                      >
                        Supprimer
                      </button>
                    </div>
                  )}
                </div>
              </div>
            ))
          }
        </div>

        {
          collectionVinyls.length === 0 && (
            <div class="text-center py-12">
              <div class="text-neutral-600 dark:text-neutral-400 mb-4">
                <svg
                  class="mx-auto h-12 w-12"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 11H5m14-5v12a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2z"
                  />
                </svg>
              </div>
              <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-50 mb-2">
                Aucun vinyle dans cette collection
              </h3>
              <p class="text-neutral-600 dark:text-neutral-400 mb-4">
                Commencez par ajouter quelques vinyles à votre collection.
              </p>
              {currentUser && currentUser.id === collection.userId && (
                <button
                  id="add-vinyl-empty-btn"
                  class="bg-gradient-emerald dark:bg-gradient-emerald text-white px-6 py-2 rounded-xl hover:bg-gradient-emerald/80 dark:hover:bg-gradient-emerald/80 transition-colors"
                >
                  Ajouter un vinyle
                </button>
              )}
            </div>
          )
        }
      </div>
  </div>
    ) : (
      <div class="text-center py-12">
        <div class="inline-flex items-center">
          <svg class="animate-spin h-8 w-8 text-gradient-emerald dark:text-gradient-emerald mr-3" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="text-lg text-neutral-600 dark:text-neutral-400">Chargement de la collection...</span>
        </div>
      </div>
    )}
  </div>

  <Footer slot="footer" />

  <!-- Modals -->
  <BarcodeScannerModal />
  <DeleteVinylModal />
</BaseLayout>

<script>
  // Gestion des vues (grille/liste)
  document.addEventListener("DOMContentLoaded", () => {
    const gridViewBtn = document.getElementById("grid-view");
    const listViewBtn = document.getElementById("list-view");
    const vinylGrid = document.getElementById("vinyl-grid");
    const vinylList = document.getElementById("vinyl-list");

    function switchToGridView() {
      gridViewBtn?.classList.add(
        "bg-neutral-50",
        "dark:bg-neutral-950",
        "text-neutral-900",
        "dark:text-neutral-50",
        "shadow-sm dark:shadow-white dark:shadow-dark-card"
      );
      gridViewBtn?.classList.remove(
        "text-neutral-600",
        "dark:text-neutral-400"
      );
      listViewBtn?.classList.remove(
        "bg-neutral-50",
        "dark:bg-neutral-950",
        "text-neutral-900",
        "dark:text-neutral-50",
        "shadow-sm dark:shadow-white dark:shadow-dark-card"
      );
      listViewBtn?.classList.add(
        "text-neutral-600",
        "dark:text-neutral-400"
      );

      vinylGrid?.classList.remove("hidden");
      vinylList?.classList.add("hidden");
    }

    function switchToListView() {
      listViewBtn?.classList.add(
        "bg-neutral-50",
        "dark:bg-neutral-950",
        "text-neutral-900",
        "dark:text-neutral-50",
        "shadow-sm dark:shadow-white dark:shadow-dark-card"
      );
      listViewBtn?.classList.remove(
        "text-neutral-600",
        "dark:text-neutral-400"
      );
      gridViewBtn?.classList.remove(
        "bg-neutral-50",
        "dark:bg-neutral-950",
        "text-neutral-900",
        "dark:text-neutral-50",
        "shadow-sm dark:shadow-white dark:shadow-dark-card"
      );
      gridViewBtn?.classList.add(
        "text-neutral-600",
        "dark:text-neutral-400"
      );

      vinylGrid?.classList.add("hidden");
      vinylList?.classList.remove("hidden");
    }

    gridViewBtn?.addEventListener("click", switchToGridView);
    listViewBtn?.addEventListener("click", switchToListView);

    // Auto-submit des filtres
    const filterForm = document.querySelector("form");
    const selects = filterForm?.querySelectorAll("select");

    selects?.forEach((select) => {
      select.addEventListener("change", () => {
        filterForm?.submit();
      });
    });

    // Gestion des boutons d'ajout de vinyle
    const addVinylCollectionBtn = document.getElementById(
      "add-vinyl-collection-btn"
    );
    const addVinylEmptyBtn = document.getElementById("add-vinyl-empty-btn");

    const openBarcodeModal = () => {
      if (typeof (window as any).openBarcodeModal === "function") {
        (window as any).openBarcodeModal();
      } else {
        console.error("Modal de scan de code-barres non disponible");
        alert(
          "Le modal de scan de code-barres n'est pas disponible. Veuillez recharger la page."
        );
      }
    };

    addVinylCollectionBtn?.addEventListener("click", openBarcodeModal);
    addVinylEmptyBtn?.addEventListener("click", openBarcodeModal);

    // Gestion des boutons de suppression dans la vue liste
    const deleteButtons = document.querySelectorAll('button[data-vinyl-id]');
    deleteButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const vinylId = button.getAttribute('data-vinyl-id');
        if (!vinylId) return;
        
        // Récupérer les informations du vinyle depuis les attributs data
        const vinyl = {
          id: vinylId,
          title: button.getAttribute('data-vinyl-title') || 'Titre inconnu',
          artist: button.getAttribute('data-vinyl-artist') || 'Artiste inconnu',
          year: button.getAttribute('data-vinyl-year') || '',
          format: button.getAttribute('data-vinyl-format') || '',
          condition: button.getAttribute('data-vinyl-condition') || '',
          price: parseFloat(button.getAttribute('data-vinyl-price') || '0'),
          coverImage: button.getAttribute('data-vinyl-cover') || '/default-vinyl-cover.svg'
        };

        // Vérifier que les données essentielles sont présentes
        if (!vinyl.title || vinyl.title === 'Titre inconnu') {
          console.error('Titre du vinyle manquant');
        }
        if (!vinyl.artist || vinyl.artist === 'Artiste inconnu') {
          console.error('Artiste du vinyle manquant');
        }

        console.log('Bouton cliqué:', button);
        console.log('Tous les attributs du bouton:', button.attributes);
        console.log('Attributs data:', {
          id: button.getAttribute('data-vinyl-id'),
          title: button.getAttribute('data-vinyl-title'),
          artist: button.getAttribute('data-vinyl-artist'),
          year: button.getAttribute('data-vinyl-year'),
          format: button.getAttribute('data-vinyl-format'),
          condition: button.getAttribute('data-vinyl-condition'),
          price: button.getAttribute('data-vinyl-price'),
          cover: button.getAttribute('data-vinyl-cover')
        });
        console.log('Données du vinyle à supprimer:', vinyl);
        
        // Vérifier si les données sont vides
        if (!vinyl.title || vinyl.title === 'Titre inconnu') {
          console.error('PROBLÈME: Titre manquant ou vide');
        }
        if (!vinyl.artist || vinyl.artist === 'Artiste inconnu') {
          console.error('PROBLÈME: Artiste manquant ou vide');
        }

        // Ouvrir la modal de confirmation
        if (typeof (window as any).openDeleteVinylModal === 'function') {
          (window as any).openDeleteVinylModal(vinyl);
        } else {
          console.error('Modal de suppression non disponible');
          // Fallback avec confirm
          if (confirm(`Êtes-vous sûr de vouloir supprimer "${vinyl.title}" de votre collection ?`)) {
            await removeFromCollection(vinylId);
          }
        }
      });
    });

    // Fonction pour supprimer un vinyle de la collection
    async function removeFromCollection(vinylId: string) {
      try {
        const response = await fetch(`/api/collections/remove`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ vinylId }),
        });

        if (response.ok) {
          // Recharger la page pour mettre à jour l'affichage
          window.location.reload();
        } else {
          const error = await response.json();
          console.error('Erreur lors de la suppression:', error);
          alert('Erreur lors de la suppression du vinyle');
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert('Erreur lors de la suppression du vinyle');
      }
    }
  });
</script>
